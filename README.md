# Документация

### Содержание

+ [Быстрый запуск](#Quickstart);
    + [Требования](#Req);
    + [Переменные](#Vars);
    + [Определние сервисов для развертывания](#Def_services);
    + [Настройка openvpn-client](#OVPN);
    + [Монтирование](#Mount);
    + [Запуск](#Start);
    
## <a name="Quickstart"></a> Быстрый запуск

### <a name="Req"></a> Требования

Перед запуском скрипта необходимо установить гипервизор, если в качестве гипервизора используется kvm, то необходимо так же установить драйвера.

### <a name="Vars"></a> Переменные

В файле `config` необходимо определить переменные:

| Variable name | Description | Required | Example |
| ------------- | ----------- | -------- | ------- |
| LOCALDEV_REGISTRY_USERNAME | пользователь гитлаб репозитория | Да |user |
| LOCALDEV_REGISTRY_PASSWORD | пароль пользователя гитлаб репозитория | Да | my_token |
| LOCALDEV_REGISTRY_SERVER | адрес private docker registry server, используется для создания секрета, и скачивания образов | Да | registry.gruzer.ru |
| GITLAB_EMAIL | почта пользователя гитлаб репозитория | Да | kkalynovskyi@gmail.com |
| KUBECTL_VERSION | желаямая версия kubectl | Нет | v1.9.3 |
| MINIKUBE_VERSION | желаемая версия minikube | Нет | latest |
| MINIKUBE_VM_DRIVER | драйвер для виртуальной машины | Нет | virtualbox |

### <a name="Def_services"></a> Определние сервисов для развертывания
Для установки сервиса в локально развернутом кубернетесе, необходимо в директории `services` создать файл и определить в нем переменные:

| Variable name | Description | Required | Example |
| ------------- | ----------- | -------- | ------- |
| SERVICE_NAME | Имя сервиса, который будет установлен (скрипт будет искать директорию с именем сервиса и `helm` чартом в ней) | Да | ext-api |
| GIT_REPO_PROJECT_BASE | Если указано, сервис репозиторий будет склонирова по ссылке: <GIT_REPO_PROJECT_BASE>.<SERVICE_NAME>.git | Нет | git@gitlab.gruzer.ru:apps |
| LOCALDEV_BRANCH | Ветвь, которая будет использована при клонировании локального репозитория, так же будет использована как часть FQDN, пространства именем в кубернетесе | Нет | stage |
| LOCALDEV_USERNAME | Имя пользователя, которое будет использовано в `helm` чарте, может быть необходимо какому-либо сервису | Да | yes |
| REMOTE_CLUSTER | Доменное имя, куда трафик должен быть перенаправлен | Нет | cluster.local |
| LOCALDEV_FAILOVER_BRANCH | То же самое что и LOCALDEV_BRANCH, но используется на удаленном кластере | Если REMOTE_CLUSTER опеределен | master |

### <a name="OVPN"></a> Настройка openvpn-client

Необходимо в папку `./secrets/` поместить конфигурационный файл для openvpn-client. 

### <a name="Mount"></a> Монтирование 

При запуске `minikube` содержимое папки `~/.localdev/services/` автоматически будет смонтировано на `minikube` в директорию `/home/services/`. Необходимые файлы приложений можно редактировать в папке `~/.localdev/services/` и выполнять перезапуск `minikube`.

### <a name="Start"></a> Запуск

3апустить выполнение скрипта:
```sh
$ ./deploy.sh
```
Данный скрипт сначала устанавливает `minikube` и `kubectl`, а затем поднимает кубернетес кластер на миникубе. Так же выполняется установка утилиты для управления чартами кубернетеса - `helm`.
На готовом кубернетес кластере можно отдельно запустить `install_service.sh`, в этом случае установка утилит будет пропущена, а развернутся только сервисы.
